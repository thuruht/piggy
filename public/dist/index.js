import{a as u}from"./chunk-QXHY36KT.js";var l=class{constructor(){this.translations={},this.currentLang="en",this.magicCode=this.generateMagicCode(),this.vectorSource=new ol.source.Vector,this.markers=[],this.stats={ice:0,pig:0,total:0,today:0},this.displayedMarkerIds=new Set,this.ws=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.deferredPrompt=null}generateMagicCode(){return Math.random().toString(36).substring(2,15)}async init(){this.showLoadingIndicator();try{await this.loadTranslations(),this.setupEventListeners(),this.updateUIText(),this.setupMap(),await this.loadMarkers(),this.animateEntrance(),this.startAutoRefresh(),this.setupRefreshButton(),this.connectWebSocket(),this.setupInstallPrompt()}catch(e){console.error("Init error:",e),this.showToast("Failed to load application","error")}finally{this.hideLoadingIndicator()}}async loadTranslations(){let e=await fetch("./pmaptranslate.json");this.translations=await e.json()}t(e){return this.translations[this.currentLang]?.[e]||e}setupMap(){let e=ol.proj.fromLonLat([-94.5786,39.0997]);try{this.map=new ol.Map({target:"map",layers:[new ol.layer.Tile({source:new ol.source.OSM}),new ol.layer.Vector({source:this.vectorSource,style:this.getMarkerStyle.bind(this)})],view:new ol.View({center:e,zoom:window.innerWidth<768?10:11})}),this.map.on("click",this.onMapClick.bind(this)),setTimeout(()=>{this.map&&this.map.updateSize()},100),u(this.map)}catch(t){console.error("Map setup error:",t),document.getElementById("map").innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;">Map failed to load. Please refresh.</div>'}}getMarkerStyle(e){let t=e.get("type"),o=t==="ICE"?"#ff4444":"#4444ff";return new ol.style.Style({image:new ol.style.Icon({anchor:[.5,1],src:`data:image/svg+xml,${encodeURIComponent(`
          <svg width="24" height="36" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 0C5.4 0 0 5.4 0 12c0 9 12 24 12 24s12-15 12-24c0-6.6-5.4-12-12-12z" fill="${o}"/>
            <circle cx="12" cy="12" r="6" fill="white"/>
            <text x="12" y="16" text-anchor="middle" font-size="8" fill="${o}">${t}</text>
          </svg>
        `)}`})})}setupEventListeners(){document.getElementById("addBtn").onclick=()=>this.toggleAddMode(),document.getElementById("vizBtn").onclick=()=>this.toggleSidebar(),document.getElementById("closeSidebar").onclick=()=>this.closeSidebar(),document.getElementById("langSelect").onchange=e=>this.changeLang(e.target.value),document.querySelector(".close").onclick=()=>this.closeModal(),document.getElementById("searchBtn").addEventListener("click",()=>this.searchLocation()),document.getElementById("searchInput").addEventListener("keypress",e=>{e.key==="Enter"&&this.searchLocation()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&this.closeModal(),e.key==="d"&&e.ctrlKey&&(e.preventDefault(),this.toggleSidebar())})}async onMapClick(e){if(this.addMode){let t=ol.proj.toLonLat(e.coordinate);this.showAddMarkerModal(t)}else{let t=this.map.forEachFeatureAtPixel(e.pixel,o=>o);t&&this.showMarkerDetails(t)}}showAddMarkerModal(e){document.getElementById("modal-body").innerHTML=`
      <h3 style="margin-top: 0; color: #2c3e50;">${this.t("add_new_marker")}</h3>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Report Type</label>
        <select id="markerType" style="background: white;">
          <option value="ICE">\u{1F6A8} ICE Activity</option>
          <option value="PIG">\u{1F437} PIG Activity</option>
        </select>
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Title *</label>
        <input id="markerTitle" placeholder="Brief description of the incident" required>
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Details</label>
        <textarea id="markerDesc" placeholder="Additional details, time, description..."></textarea>
      </div>
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Media (Optional)</label>
        <input id="mediaUpload" type="file" accept="image/*,video/*" multiple>
        <small style="color: #666; font-size: 12px;">Images and videos are uploaded anonymously</small>
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="tracker.closeModal()" style="background: #95a5a6;">${this.t("cancel")}</button>
        <button onclick="tracker.saveMarker([${e}])" class="primary-btn">${this.t("save")}</button>
      </div>
    `;let t=document.getElementById("modal");t.style.display="block",gsap.from(".modal-content",{scale:.8,opacity:0,duration:.3,ease:"back.out(1.7)"})}async saveMarker(e){let t=document.getElementById("markerType").value,o=document.getElementById("markerTitle").value,s=document.getElementById("markerDesc").value,r=document.getElementById("mediaUpload").files;if(!o){this.showToast("Please enter a title","error");return}let a={id:Date.now().toString(),type:t,title:o,description:s,coords:e,timestamp:new Date().toISOString(),magicCode:this.magicCode,media:[]},i=document.querySelector(".modal-content .primary-btn"),h=i.textContent;i.textContent="Saving...",i.disabled=!0;try{let d=[],m=0;if(r.length>0){i.textContent=`Uploading ${r.length} file(s)...`;let y=Array.from(r).map(c=>this.uploadMedia(c,a.id));(await Promise.allSettled(y)).forEach(c=>{c.status==="fulfilled"&&c.value?d.push(c.value):m++}),a.media=d}i.textContent="Saving report...",await this.saveToCloudflare(a),this.markers.push(a),this.addMarkerToMap(a),this.updateStats(),this.updateCharts(),this.closeModal(),this.addMode=!1;let p="Report saved successfully!";m>0?(p+=` (${m} media file(s) failed to upload.)`,this.showToast(p,"error")):this.showToast(p,"success")}catch(d){console.error("Save marker critical error:",d),this.showToast("Failed to save the report. Please try again.","error")}finally{i.textContent=h,i.disabled=!1}}async uploadMedia(e,t){try{let o=await fetch("/api/upload-url",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:e.name,contentType:e.type})});if(!o.ok)throw new Error(`Upload URL request failed: ${o.status}`);let s=await o.json();if(s.error)throw new Error(s.error);let r=await fetch(s.uploadUrl,{method:"PUT",body:e,headers:{"Content-Type":e.type}});if(!r.ok)throw new Error(`Upload failed: ${r.status}`);return s.publicUrl}catch(o){return console.error("Upload failed:",o),this.showToast(`Upload failed: ${o.message}`,"error"),null}}async saveToCloudflare(e){let t=3,o=1e3;for(;t>0;){let s=await fetch("/api/markers",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(s.ok)return s.json();if(s.status===429)console.warn("Rate limited. Retrying..."),await new Promise(r=>setTimeout(r,o)),o*=2,t--;else{let r=await s.json().catch(()=>({error:"Unknown error"}));throw new Error(r.error||"Failed to save marker")}}throw new Error("Rate limit exceeded. Try again later.")}addMarkerToMap(e){if(this.displayedMarkerIds.has(e.id))return console.log(`Marker ${e.id} already displayed, skipping`),null;let t=(e.coords[1]+180)%360-180;if(isNaN(e.coords[0])||isNaN(t))return console.error("Invalid coordinates for marker:",e),null;let o=this.getMarkerColor(e),s=this.createMarkerStyle(o),r=new ol.Feature({geometry:new ol.geom.Point(ol.proj.fromLonLat([t,e.coords[0]])),...e});return r.setStyle(s),this.vectorSource.addFeature(r),this.displayedMarkerIds.add(e.id),setTimeout(()=>{let a=this.map.getPixelFromCoordinate(ol.proj.fromLonLat([t,e.coords[0]]));a&&this.animateMarkerPulse(a)},100),r}animateMarkerPulse(e){let t=document.createElement("div");t.className="marker-pulse",t.style.left=e[0]+"px",t.style.top=e[1]+"px",document.body.appendChild(t),setTimeout(()=>t.remove(),2e3)}getMarkerColor(e){let t=e.type==="ICE"?"red":"blue",o=Date.now()-new Date(e.timestamp).getTime(),s=24*60*60*1e3;return o<s?`${t}-bright`:o<7*s?t:`${t}-faded`}createMarkerStyle(e){let t={"red-bright":"#ff0000",red:"#cc0000","red-faded":"#880000","blue-bright":"#0000ff",blue:"#0000cc","blue-faded":"#000088"};return new ol.style.Style({image:new ol.style.Circle({radius:8,fill:new ol.style.Fill({color:t[e]||"#ff0000"}),stroke:new ol.style.Stroke({color:"#fff",width:2})})})}async refreshMarkers(){try{let t=await(await fetch("/api/markers")).json(),o=0;t.forEach(s=>{this.displayedMarkerIds.has(s.id)||(this.addMarkerToMap(s),o++)}),o>0?this.showToast(`Added ${o} new marker(s)`,"success"):this.showToast("Map is up to date","success")}catch(e){console.error("Refresh error:",e),this.showToast("Failed to refresh markers","error")}}startAutoRefresh(){setInterval(()=>this.refreshMarkers(),6e4)}setupRefreshButton(){let e=document.createElement("button");e.id="refresh-btn",e.className="secondary-btn",e.innerHTML="\u21BB",e.title="Refresh Map",e.addEventListener("click",()=>{e.innerHTML="...",this.refreshMarkers().finally(()=>{e.innerHTML="\u21BB"})}),document.querySelector(".controls").appendChild(e)}async loadMarkers(){try{let t=await(await fetch("/api/markers")).json();this.markers=t,this.updateStats(),t.forEach(o=>this.addMarkerToMap(o)),this.updateCharts()}catch(e){console.error("Failed to load markers:",e)}}showMarkerDetails(e){let t=e.getProperties(),o=t.media&&t.media.length>0?t.media.map(h=>`<img src="${h}" class="media-preview" onerror="this.style.display='none'">`).join(""):"",s=`upvoted_${t.id}`,r=`reported_${t.id}`,a=sessionStorage.getItem(s),i=sessionStorage.getItem(r);document.getElementById("modal-body").innerHTML=`
  <h3>${t.title}</h3>
  <div class="modal-meta">
    <span><strong>Type:</strong> ${t.type}</span>
    <span><strong>Posted:</strong> ${new Date(t.timestamp).toLocaleString()}</span>
  </div>
  <p>${t.description||"No description"}</p>
  ${o}
  
  <div class="modal-actions">
    <button id="report-btn" onclick="tracker.reportMarker('${t.id}')" ${i?"disabled":""}>
      ${i?"\u2713 Reported":"\u26A0 Report"}
    </button>
    <button id="upvote-btn" onclick="tracker.upvoteMarker('${t.id}')" ${a?"disabled":""}>
      \u{1F44D} ${a?this.t("upvoted"):this.t("upvote")} (<span id="upvote-count">${t.upvotes||0}</span>)
    </button>
  </div>

  <div id="comments"><h4>${this.t("comments")}</h4></div>
  <textarea id="newComment" placeholder="${this.t("add_comment")}"></textarea>
  <input id="commentAuthor" placeholder="${this.t("author")}">
  <button onclick="tracker.addComment('${t.id}')">${this.t("add_comment")}</button>
  
  ${this.canEdit(t)?`
    <div class="admin-actions">
      <button onclick="tracker.deleteMarker('${t.id}')">${this.t("delete")}</button>
    </div>
  `:""}
`,this.loadComments(t.id),document.getElementById("modal").style.display="block"}async upvoteMarker(e){let t=document.getElementById("upvote-btn");if(!(!t||t.disabled))try{let o=await fetch(`/api/upvotes/${e}`,{method:"POST"});if(!o.ok){let r=await o.json();throw new Error(r.error||"Upvote failed")}let s=await o.json();sessionStorage.setItem(`upvoted_${e}`,"true"),t.disabled=!0,t.innerHTML=`\u{1F44D} ${this.t("upvoted")} (<span id="upvote-count">${s.upvotes}</span>)`,this.showToast("Upvoted!","success")}catch(o){console.error("Upvote error:",o),this.showToast(o.message,"error")}}async reportMarker(e){if(confirm(this.t("confirm_report")||"Are you sure you want to report this?"))try{if(!(await fetch(`/api/markers/${e}/report`,{method:"POST"})).ok)throw new Error("Report failed");sessionStorage.setItem(`reported_${e}`,"true");let o=document.getElementById("report-btn");o&&(o.disabled=!0,o.textContent="\u2713 Reported"),this.showToast("Report submitted. Thank you.","success")}catch(t){console.error("Report error:",t),this.showToast("Failed to submit report","error")}}connectWebSocket(){try{let t=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws`;this.ws=new WebSocket(t),this.ws.onopen=()=>{console.log("WebSocket connected"),this.reconnectAttempts=0,this.showToast("Connected to live updates","success")},this.ws.onmessage=o=>{let s=JSON.parse(o.data);this.handleWebSocketMessage(s)},this.ws.onerror=o=>{console.error("WebSocket error:",o)},this.ws.onclose=()=>{console.log("WebSocket disconnected"),this.reconnectWebSocket()}}catch(e){console.error("Failed to establish WebSocket:",e)}}reconnectWebSocket(){if(this.reconnectAttempts<this.maxReconnectAttempts){let e=Math.min(1e3*Math.pow(2,this.reconnectAttempts),3e4);this.reconnectAttempts++,console.log(`Reconnecting in ${e}ms (attempt ${this.reconnectAttempts})`),setTimeout(()=>this.connectWebSocket(),e)}else this.showToast("Live updates disconnected. Refresh page to reconnect.","error")}handleWebSocketMessage(e){switch(console.log("WebSocket message:",e),e.type){case"welcome":console.log(`Connected. ${e.activeUsers} active users`),this.updateActiveUsers(e.activeUsers);break;case"marker_added":this.displayedMarkerIds.has(e.marker.id)||(this.addMarkerToMap(e.marker),this.showToast("New report added","info"),this.triggerHaptic(20));break;case"active_users":this.updateActiveUsers(e.count);break;default:console.log("Unknown message type:",e.type)}}updateActiveUsers(e){let t=document.getElementById("active-users");t||(t=document.createElement("div"),t.id="active-users",t.className="active-users-indicator",document.querySelector(".controls").appendChild(t)),t.textContent=`\u{1F465} ${e} online`}sendUserLocation(){if(this.ws&&this.ws.readyState===WebSocket.OPEN){let e=this.map.getView().getCenter(),t=ol.proj.toLonLat(e);this.ws.send(JSON.stringify({type:"user_location",location:{lat:t[1],lng:t[0]}}))}}canEdit(e){return e.magicCode===this.magicCode||localStorage.getItem(`edit_${e.id}`)==="true"}async addComment(e){let t=document.getElementById("newComment").value,o=document.getElementById("commentAuthor").value;if(!t)return;let s={markerId:e,text:t,author:o||"Anonymous"};try{if(!(await fetch("/api/comments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).ok)throw new Error("Failed to save comment");this.loadComments(e),this.showToast("Comment added"),document.getElementById("newComment").value="",document.getElementById("commentAuthor").value=""}catch(r){console.error("Comment error:",r),this.showToast("Failed to add comment","error")}}async loadComments(e){try{let o=await(await fetch(`/api/comments/${e}`)).json();document.getElementById("comments").innerHTML=o.map(s=>`
        <div class="comment">
          <div class="comment-author">${s.author}</div>
          <div class="comment-time">${new Date(s.timestamp).toLocaleString()}</div>
          <p>${s.text}</p>
        </div>
      `).join("")}catch(t){console.error("Failed to load comments:",t)}}toggleAddMode(){this.addMode=!this.addMode;let e=document.getElementById("addBtn");this.addMode?(e.innerHTML='<span class="btn-icon">\u2715</span> Done',e.style.background="linear-gradient(45deg, #95a5a6, #7f8c8d)",this.showToast(this.t("add_marker_instruction")||"Click on the map to add a report")):(e.innerHTML=`<span class="btn-icon">+</span> ${this.t("add_new_marker")}`,e.style.background="linear-gradient(45deg, #ff6b6b, #ee5a52)"),gsap.to(e,{scale:1.05,duration:.1,yoyo:!0,repeat:1})}changeLang(e){this.currentLang=e,this.updateUIText()}closeModal(){document.getElementById("modal").style.display="none"}triggerHaptic(e=20){"vibrate"in navigator&&navigator.vibrate(e)}playSound(e){try{let t=new(window.AudioContext||window.webkitAudioContext),o=t.createOscillator(),s=t.createGain();o.connect(s),s.connect(t.destination),e==="success"?(o.frequency.value=800,s.gain.setValueAtTime(.1,t.currentTime),s.gain.exponentialRampToValueAtTime(.01,t.currentTime+.1),o.start(t.currentTime),o.stop(t.currentTime+.1)):e==="error"&&(o.frequency.value=300,s.gain.setValueAtTime(.1,t.currentTime),s.gain.exponentialRampToValueAtTime(.01,t.currentTime+.2),o.start(t.currentTime),o.stop(t.currentTime+.2))}catch{console.log("Audio not supported")}}showToast(e,t="info"){let o=document.getElementById("toast-container"),s=document.createElement("div");s.className=`toast toast-${t}`,s.textContent=e,o.appendChild(s),setTimeout(()=>{s.style.opacity="1",s.style.transform="translateX(0)"},10),setTimeout(()=>{s.style.opacity="0",s.style.transform="translateX(100%)",setTimeout(()=>s.remove(),500)},3e3),t==="success"?(this.triggerHaptic(20),this.playSound("success")):t==="error"&&(this.triggerHaptic([50,50,50]),this.playSound("error"))}async deleteMarker(e){if(confirm(this.t("confirm_delete")))try{if(!(await fetch(`/api/markers/${e}`,{method:"DELETE"})).ok)throw new Error("Failed to delete marker");let o=this.vectorSource.getFeatures().find(s=>s.get("id")===e);o&&this.vectorSource.removeFeature(o),this.markers=this.markers.filter(s=>s.id!==e),this.updateStats(),this.updateCharts(),this.showToast("Report deleted"),this.closeModal()}catch(t){console.error("Delete error:",t),this.showToast("Failed to delete report","error")}}setupInstallPrompt(){window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),this.deferredPrompt=e,this.showInstallButton()}),window.addEventListener("appinstalled",()=>{console.log("PWA installed"),this.deferredPrompt=null,this.hideInstallButton(),this.showToast("App installed! Open from your home screen.","success")})}showInstallButton(){let e=document.createElement("button");e.id="install-btn",e.className="secondary-btn",e.innerHTML="\u{1F4F1} Install App",e.addEventListener("click",()=>this.promptInstall()),document.querySelector(".controls").appendChild(e)}hideInstallButton(){let e=document.getElementById("install-btn");e&&e.remove()}async promptInstall(){if(!this.deferredPrompt)return;this.deferredPrompt.prompt();let{outcome:e}=await this.deferredPrompt.userChoice;console.log(`Install prompt outcome: ${e}`),this.deferredPrompt=null,this.hideInstallButton()}async searchLocation(){let e=document.getElementById("searchInput").value;if(!e){this.showToast("Please enter a location to search.","error");return}this.showToast(`Searching for "${e}"...`,"info");try{let t=await fetch(`/api/search?q=${encodeURIComponent(e)}`);if(!t.ok)throw new Error("Network response was not ok.");let o=await t.json();if(o.length>0){let{lat:s,lon:r}=o[0];this.showToast("Location found. Moving map...","success"),this.panToLocation([parseFloat(r),parseFloat(s)])}else this.showToast(`Could not find "${e}".`,"error")}catch(t){console.error("Nominatim search error:",t),this.showToast("Failed to perform search.","error")}}panToLocation(e){this.map&&this.map.getView().animate({center:ol.proj.fromLonLat(e),zoom:14,duration:1500,easing:ol.easing.easeOut})}};l.prototype.showLoadingIndicator=function(){let n=document.getElementById("loading-indicator");n&&(n.style.display="flex")};l.prototype.hideLoadingIndicator=function(){let n=document.getElementById("loading-indicator");n&&n.remove()};l.prototype.updateUIText=function(){document.querySelectorAll("[data-translate-key]").forEach(n=>{let e=n.dataset.translateKey,t=this.t(e);if(n.children.length===0||n.tagName==="TITLE"){n.textContent=t;return}for(let o of n.childNodes)if(o.nodeType===Node.TEXT_NODE&&o.textContent.trim().length>0){o.textContent=` ${t}`;break}})};export{l as ICEPIGTracker};
//# sourceMappingURL=index.js.map
